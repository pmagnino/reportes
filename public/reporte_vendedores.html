<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ranking Vendedores | Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
    .report-header { background: white; border-bottom: 2px solid #e9ecef; padding: 15px 0; }
    .kpi-card { background: white; border-radius: 12px; padding: 1.5rem; border-left: 5px solid #4361ee; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .kpi-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
    .kpi-value { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
    .total-main { background: #1e293b; color: white; border-left: none; }
    .total-main .kpi-value, .total-main .kpi-label { color: #f8f9fa; }
    .table-container { background: white; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
  </style>
</head>
<body class="pb-5">

<header class="report-header sticky-top mb-4 shadow-sm">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
    <h4 class="fw-bold mb-0 text-primary">Ranking de Vendedores</h4>
    <div class="d-flex flex-wrap justify-content-center gap-2">
      <input type="date" id="desde" class="form-control form-control-sm w-auto border-2">
      <input type="date" id="hasta" class="form-control form-control-sm w-auto border-2">
      <select id="sucursal" class="form-select form-select-sm w-auto border-2"></select>
      <button class="btn btn-primary btn-sm px-4 fw-bold" onclick="consultar()">CONSULTAR</button>
      <a href="index.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-house"></i></a>
    </div>
  </div>
</header>

<div class="container">
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3 mb-4">
    <div class="col"><div class="kpi-card"><div class="kpi-label">Ventas A</div><div id="t-fact-a" class="kpi-value">0</div></div></div>
    <div class="col"><div class="kpi-card" style="border-left-color: #2ec4b6;"><div class="kpi-label">Ventas B</div><div id="t-fact-b" class="kpi-value">0</div></div></div>
    <div class="col"><div class="kpi-card" style="border-left-color: #ff9f1c;"><div class="kpi-label">Operaciones</div><div id="t-ops" class="kpi-value">0</div></div></div>
    <div class="col"><div class="kpi-card total-main shadow"><div class="kpi-label opacity-75">Neto Recaudado</div><div id="t-gen" class="kpi-value">$ 0</div></div></div>
  </div>

  <div class="table-container table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr class="small text-muted">
          <th class="ps-4">VENDEDOR</th>
          <th class="text-center">FACT A</th>
          <th class="text-center">FACT B</th>
          <th class="text-center">OPS</th>
          <th class="text-end pe-4">TOTAL RECAUDADO</th>
        </tr>
      </thead>
      <tbody id="tabla-body">
        <tr><td colspan="5" class="text-center py-5 text-muted">Configure los filtros para ver el ranking</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const h = new Date().toISOString().split('T')[0];
    document.getElementById('desde').value = h;
    document.getElementById('hasta').value = h;
    const res = await fetch('/api/sucursales');
    const sucs = await res.json();
    document.getElementById('sucursal').innerHTML = sucs.map(s => `<option value="${s.CODSUC}">${s.NOMBRE}</option>`).join('');
  });

  async function consultar() {
    const body = document.getElementById('tabla-body');
    body.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';
    
    const res = await fetch(`/api/reporte/vendedores?sucursal=${document.getElementById('sucursal').value}&desde=${document.getElementById('desde').value}&hasta=${document.getElementById('hasta').value}`);
    const data = await res.json();
    
    let sumaGral = 0, factA = 0, factB = 0, ops = 0;
    const fmt = { style: 'currency', currency: 'ARS' };

    body.innerHTML = data.map(r => {
      sumaGral += r.TOTAL_NUMERICO; factA += r.CANTIDAD_FACTURAS_A; factB += r.CANTIDAD_FACTURAS_B; ops += r.TOTAL_OPERACIONES;
      return `<tr>
        <td class="ps-4 fw-bold">${r.CODVENDEDOR}</td>
        <td class="text-center">${r.CANTIDAD_FACTURAS_A}</td>