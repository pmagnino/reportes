<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ranking Vendedores | Mimo & Co</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- ðŸ” Auth -->
    <script src="auth.js"></script>

    <style>
        body { background-color: #f4f7f9; font-family: 'Segoe UI', sans-serif; color: #555; font-size: 0.75rem; }
        .report-header { background: white; border-bottom: 1px solid #e0e0e0; padding: 12px 0; }
        .brand-logo { height: 38px; }

        .contenedor-ranking { background: white; border-radius: 8px; padding: 20px; border: 1px solid #eef2f7; }
        .table-ranking { width: 100%; border-collapse: collapse; }
        .table-ranking th { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; font-size: 0.65rem; }
        .table-ranking td { border: 1px solid #dee2e6; padding: 10px; }

        .medal { font-size: 1.1rem; margin-left: 5px; }
        .oro { color: #FFD700; }
        .plata { color: #C0C0C0; }
        .bronce { color: #CD7F32; }

        .winner-card {
            background: linear-gradient(135deg, #1d3557 0%, #457b9d 100%);
            color: white;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
        }

        .btn-home { color: #555; font-size: 1.2rem; }
    </style>
</head>

<body onload="protectPage()">

<header class="report-header sticky-top mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="Logo.png" class="brand-logo" alt="Mimo & Co">
            <h6 class="fw-bold mb-0 ms-3 text-dark">RANKING VENDEDORES</h6>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <input type="date" id="desde" class="form-control form-control-sm">
            <input type="date" id="hasta" class="form-control form-control-sm">
            <select id="sucursal" class="form-select form-select-sm"></select>

            <button class="btn btn-dark btn-sm px-4" onclick="consultar()">VER RANKING</button>
            <div class="vr mx-2"></div>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Salir</button>
        </div>
    </div>
</header>

<div class="container">
    <div class="row g-4">
        <div class="col-md-8">
            <div class="contenedor-ranking">
                <table class="table-ranking text-center">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th class="text-start ps-4">ID VENDEDOR</th>
                            <th>OPERACIONES</th>
                            <th class="text-end pe-4">NETO VENDIDO</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        <tr><td colspan="4" class="py-5 text-muted">Aguardando consulta...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-md-4">
            <div id="destacado-vendedor" style="display:none;">
                <div class="winner-card">
                    <i class="bi bi-trophy-fill mb-2" style="font-size: 2rem;"></i>
                    <div id="winner-id-display" class="fs-2"></div>
                    <div id="winner-monto" class="fs-5"></div>
                    <div class="mt-2">
                        <small>Ticket Promedio</small>
                        <div id="winner-avg"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const res = await authFetch('/api/sucursales');
    const sucs = await res.json();

if (!Array.isArray(sucs)) {
    console.error('Respuesta invÃ¡lida:', sucs);
    throw new Error('No se pudieron cargar las sucursales');
}
    document.getElementById('sucursal').innerHTML =
        sucs.map(s => `<option value="${s.CODSUC}">${s.NOMBRE}</option>`).join('');
});

async function consultar() {
    const tbody = document.getElementById('tabla-body');
    const suc = document.getElementById('sucursal').value;
    const desde = document.getElementById('desde').value;
    const hasta = document.getElementById('hasta').value;

    tbody.innerHTML = `<tr><td colspan="4" class="py-4 text-center">
        <div class="spinner-border spinner-border-sm"></div>
    </td></tr>`;

    try {
        const res = await authFetch(`/api/reporte/vendedores?sucursal=${suc}&desde=${desde}&hasta=${hasta}`);
        const data = await res.json();

        if (!data.length) return;

        const top = data[0];
        document.getElementById('destacado-vendedor').style.display = 'block';
        document.getElementById('winner-id-display').innerText = top.CODVENDEDOR;
        document.getElementById('winner-monto').innerText = top.TOTAL_NUMERICO.toLocaleString('es-AR');
        document.getElementById('winner-avg').innerText =
            (top.TOTAL_NUMERICO / top.TOTAL_OPERACIONES).toLocaleString('es-AR');

        tbody.innerHTML = data.map((v, i) => `
            <tr>
                <td>${i + 1}</td>
                <td class="text-start ps-4">${v.CODVENDEDOR}</td>
                <td>${v.TOTAL_OPERACIONES}</td>
                <td class="text-end pe-4">${v.TOTAL_NUMERICO.toLocaleString('es-AR')}</td>
            </tr>
        `).join('');

    } catch {
        tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center py-4">Error al cargar datos</td></tr>';
    }
}
</script>

</body>
</html>
