<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas Detalladas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f4f7f6; font-family: sans-serif; }
    .kpi-card { background: white; border-radius: 12px; padding: 1.2rem; border-left: 5px solid #4361ee; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .kpi-label { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
    .kpi-value { font-size: 1.3rem; font-weight: 800; color: #1e293b; }
    .bg-total { background: #1e293b; color: white; border: none; }
    .bg-total .kpi-label, .bg-total .kpi-value { color: #f8f9fa; }
    .card-factura { border: none; border-radius: 15px; overflow: hidden; }
  </style>
</head>
<body class="pb-5">

<header class="bg-white border-bottom py-3 sticky-top shadow-sm mb-4">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
    <h4 class="fw-bold mb-0 text-primary">Detalle de Comprobantes</h4>
    <div class="d-flex flex-wrap justify-content-center gap-2">
      <input type="date" id="desde" class="form-control form-control-sm w-auto">
      <input type="date" id="hasta" class="form-control form-control-sm w-auto">
      <select id="sucursal" class="form-select form-select-sm w-auto"></select>
      <button class="btn btn-primary btn-sm px-4 fw-bold" onclick="buscar()">CONSULTAR</button>
      <a href="index.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-house"></i></a>
    </div>
  </div>
</header>

<div class="container px-3">
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3 mb-4">
    <div class="col"><div class="kpi-card"><div class="kpi-label">Efectivo</div><div id="t-efvo" class="kpi-value">$ 0</div></div></div>
    <div class="col"><div class="kpi-card" style="border-left-color: #2ec4b6;"><div class="kpi-label">Tarjetas</div><div id="t-tarj" class="kpi-value">$ 0</div></div></div>
    <div class="col"><div class="kpi-card" style="border-left-color: #ff9f1c;"><div class="kpi-label">Mercado Pago</div><div id="t-mp" class="kpi-value">$ 0</div></div></div>
    <div class="col"><div class="kpi-card bg-total shadow-lg"><div class="kpi-label opacity-75">Total Neto</div><div id="t-gen" class="kpi-value">$ 0</div></div></div>
  </div>

  <div id="resultado" class="row g-3">
    <div class="text-center py-5 text-muted">Configure los filtros y presione consultar</div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const h = new Date().toISOString().split('T')[0];
    document.getElementById('desde').value = h;
    document.getElementById('hasta').value = h;
    const res = await fetch('/api/sucursales');
    const sucs = await res.json();
    document.getElementById('sucursal').innerHTML = sucs.map(s => `<option value="${s.CODSUC}">${s.NOMBRE}</option>`).join('');
  });

  async function buscar() {
    const div = document.getElementById('resultado');
    div.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
    
    try {
      const res = await fetch(`/api/facturas?sucursal=${document.getElementById('sucursal').value}&desde=${document.getElementById('desde').value}&hasta=${document.getElementById('hasta').value}`);
      const data = await res.json();
      const fmt = { style: 'currency', currency: 'ARS' };

      document.getElementById('t-efvo').innerText = data.totales.efectivo.toLocaleString('es-AR', fmt);
      document.getElementById('t-tarj').innerText = data.totales.tarjeta.toLocaleString('es-AR', fmt);
      document.getElementById('t-mp').innerText = data.totales.mp.toLocaleString('es-AR', fmt);
      document.getElementById('t-gen').innerText = data.totales.general.toLocaleString('es-AR', fmt);

      div.innerHTML = data.datos.map(f => `
        <div class="col-12 col-xl-6">
          <div class="card card-factura shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
              <span class="fw-bold text-primary">${f.prefijo}-${f.numero}</span>
              <span class="badge bg-light text-dark border font-monospace">${f.pago}</span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm mb-0 small">
                <thead class="table-light"><tr><th class="ps-3">Articulo</th><th class="text-center">Cant</th><th class="text-end pe-3">Subtotal</th></tr></thead>
                <tbody>
                  ${f.items.map(i => `<tr><td class="ps-3">${i.cod}</td><td class="text-center">${i.cant}</td><td class="text-end pe-3">${(i.cant * i.pre).toLocaleString('es-AR', fmt)}</td></tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>`).join('');
    } catch(e) { div.innerHTML = '<div class="alert alert-danger">Error al conectar con la API</div>'; }
  }
</script>
</body>
</html>